<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>전자책 뷰어 — PDF + 해설 + 연습문제</title>
    (function(){
      let cozeClient = null;
      const BOT_ID = '7576395788172050485';

      async function fetchToken(){
        try{
          const r = await fetch('/api/coze-token');
          if(!r.ok) throw new Error('Token fetch failed: ' + r.status);
          const token = await r.text();
          return token;
        }catch(e){
          console.warn('Failed to fetch Coze token from server', e);
          throw e;
        }
      }

      async function initCozeIfNeeded(){
        if(cozeClient) return;
        try{
          // obtain a token from serverless endpoint and pass an onRefreshToken that fetches again when needed
          const initialToken = await fetchToken();
          cozeClient = new CozeWebSDK.WebChatClient({
            config:{ bot_id: BOT_ID },
            componentProps:{ title:'Coze', mountElement: document.getElementById('coze-chat-anchor') },
            auth:{ type:'token', token: initialToken,
              onRefreshToken: async function(){
                return await fetchToken();
              }
            }
          });
        }catch(e){ console.warn('Coze init failed', e); }
      }

      const toggleBtn = document.getElementById('coze-toggle-btn');
      const anchor = document.getElementById('coze-chat-anchor');
      const closeBtn = anchor.querySelector('.coze-close');

      toggleBtn.addEventListener('click', async ()=>{
        // initialize on first open (get token from serverless endpoint)
        await initCozeIfNeeded();
        anchor.classList.add('coze-open');
        anchor.setAttribute('aria-hidden','false');
        toggleBtn.style.display = 'none';
      });
      closeBtn.addEventListener('click', ()=>{
        anchor.classList.remove('coze-open');
        anchor.setAttribute('aria-hidden','true');
        toggleBtn.style.display = 'flex';
      });
    })();
      scrollbar-width:none; -ms-overflow-style:none
    }
    html.auto-hide-scroll::-webkit-scrollbar, body.auto-hide-scroll::-webkit-scrollbar,
    .wrap.auto-hide-scroll::-webkit-scrollbar, .panel.auto-hide-scroll::-webkit-scrollbar,
    .right-content.auto-hide-scroll::-webkit-scrollbar, #pdfContainer.auto-hide-scroll::-webkit-scrollbar,
    .modal.auto-hide-scroll::-webkit-scrollbar, iframe.auto-hide-scroll::-webkit-scrollbar{
      width:8px;background:transparent
    }
    html.auto-hide-scroll::-webkit-scrollbar-thumb, body.auto-hide-scroll::-webkit-scrollbar-thumb,
    .wrap.auto-hide-scroll::-webkit-scrollbar-thumb, .panel.auto-hide-scroll::-webkit-scrollbar-thumb,
    .right-content.auto-hide-scroll::-webkit-scrollbar-thumb, #pdfContainer.auto-hide-scroll::-webkit-scrollbar-thumb,
    .modal.auto-hide-scroll::-webkit-scrollbar-thumb, iframe.auto-hide-scroll::-webkit-scrollbar-thumb{
      background:rgba(99,102,241,0);border-radius:8px;transition:background .18s
    }
    /* show thumb on hover or when JS adds .show-scroll */
    html.auto-hide-scroll:hover::-webkit-scrollbar-thumb, body.auto-hide-scroll:hover::-webkit-scrollbar-thumb,
    .wrap.auto-hide-scroll:hover::-webkit-scrollbar-thumb, .panel.auto-hide-scroll:hover::-webkit-scrollbar-thumb,
    .right-content.auto-hide-scroll:hover::-webkit-scrollbar-thumb, #pdfContainer.auto-hide-scroll:hover::-webkit-scrollbar-thumb,
    .modal.auto-hide-scroll:hover::-webkit-scrollbar-thumb, iframe.auto-hide-scroll:hover::-webkit-scrollbar-thumb,
    html.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb, body.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb,
    .wrap.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb, .panel.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb,
    .right-content.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb, #pdfContainer.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb,
    .modal.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb, iframe.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb{
      background:rgba(99,102,241,0.45)
    }
    /* Firefox: show thin scrollbar on hover */
    html.auto-hide-scroll:hover, body.auto-hide-scroll:hover,
    .wrap.auto-hide-scroll:hover, .panel.auto-hide-scroll:hover,
    .right-content.auto-hide-scroll:hover, #pdfContainer.auto-hide-scroll:hover,
    .modal.auto-hide-scroll:hover, iframe.auto-hide-scroll:hover{
      scrollbar-width:thin;scrollbar-color:rgba(99,102,241,0.45) transparent
    }

    @media (max-width:900px){
      .wrap{flex-direction:column;height:auto}
      .left,.right{flex:unset;width:100%}
      .right{order:2}
      .left{order:1}
      .pdf-frame{height:60vh}
      .right-content{height:40vh}
    }
      /* Coze chat: default show small floating button; expand chat only when opened */
      #coze-toggle-btn{position:fixed;right:20px;bottom:20px;z-index:1201;width:56px;height:56px;border-radius:50%;background:#5b21b6;color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(2,6,23,0.18);cursor:pointer;font-size:24px;border:0}
      #coze-toggle-btn:hover{transform:translateY(-2px)}
      /* hidden anchor (chat container) - only visible when .coze-open added */
      #coze-chat-anchor{display:none}
      #coze-chat-anchor.coze-open{position:fixed;right:20px;bottom:20px;z-index:1200;width:360px;height:560px;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,23,0.18);display:block;background:#fff}
      #coze-chat-anchor.coze-open .coze-close{position:absolute;right:8px;top:8px;z-index:1210;background:transparent;border:0;color:#374151;font-size:20px;cursor:pointer}
    @media (max-width:700px){#coze-toggle-btn{right:12px;bottom:12px}#coze-chat-anchor.coze-open{right:12px;bottom:12px;width:300px;height:480px}}

    /* Reserve space so floating chat button doesn't cover right-hand content */
    /* Add bottom gap equal to chat button height + margin */
    .right{padding-bottom:96px}
    @media (max-width:900px){ .right{padding-bottom:76px} }
  </style>
  <script>
    // helper to encode local pdf path safely
    function fileUrlFromPath(p){
      // If starts with file:// already, return encoded version
      if(p.startsWith('file:')) return p;
      // convert Windows path to file URL
      let path = p.replace(/\\/g, '/');
      if(!path.startsWith('/')){
        path = '/' + path;
      }
      return 'file://' + encodeURI(path);
    }
  </script>
  <!-- PDF.js (cdn) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    // configure worker
    if(window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    }
  </script>
</head>
<body>
  <div class="wrap">
    <section class="panel left">
      <div class="toolbar">
        <div style="flex:1">
          <div class="title">PDF 본문</div>
          <div class="hint">왼쪽에서 PDF 본문을 확인하세요.</div>
        </div>
        <div>
          <button id="openExplanation" class="btn">해설로 포커스</button>
        </div>
      </div>
  <!-- PDF 영역: JS에서 동적으로 iframe + object(fallback)를 넣습니다 -->
  <div id="pdfContainer" class="pdf-frame">Loading PDF...</div>
    </section>

    <aside class="panel right">
      <div class="toolbar">
        <div style="flex:1">
          <div class="title">쉬운 해설</div>
          <div class="hint">오른쪽 영역을 끝까지 스크롤하면 연습문제가 팝업으로 열립니다.</div>
        </div>
      </div>
      <div id="rightContent" class="right-content">
        <!-- 설명 페이지를 원형 그대로 보존하려면 iframe으로 불러옵니다. -->
        <iframe id="explainFrame" src="" title="쉬운 해설" style="width:100%;height:100%;border:0"></iframe>
        <!-- fallback manual open button (보안정책으로 스크립트 접근이 불가능한 경우 표시) -->
        <div id="explainFallback" style="display:none;padding:12px;text-align:center;">
          <p style="color:#64748b">해설 자동 감지가 불가능합니다. 아래 버튼을 눌러 연습문제를 직접 열어보세요.</p>
          <button id="openQuizManual" class="btn">연습문제 열기</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- modal for practice quiz -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <strong>연습문제</strong>
        <div>
          <button id="closeModal" class="close-btn">닫기</button>
        </div>
      </div>
      <div id="modalBody" class="modal-body">로딩 중...</div>
    </div>
  </div>

  <script>
    (function(){
      // === ?ㅼ젙 ?뱀뀡 ===
      // 1) PDF ?뚯씪 寃쎈줈 (濡쒖뺄 ?덈? 寃쎈줈 沅뚯옣). ?꾩슂?섎㈃ 寃쎈줈瑜??섏젙?섏꽭??
      const pdfRawPath = '(10가지 핵심이론으로 만나는) 지속가능경영과 ESG-part-2.pdf';
      // 2) ?댁꽕 諛??곗뒿臾몄젣 ?뚯씪? ?꾩옱 ?대뜑(chapter_01)???덈떎怨?媛??
      const explanationPath = 'easy_explanation.html';
      const quizPath = 'practice_quiz.html';

  // === PDF 로드 ===
  const pdfContainer = document.getElementById('pdfContainer');
      try{
        // Resolve PDF path relative to the current document so filenames with spaces/한글/괄호도 work.
        // new URL(..., location.href) will create an absolute URL correctly.
        let pdfUrl;
        if (pdfRawPath.startsWith('http:') || pdfRawPath.startsWith('https:') || pdfRawPath.startsWith('file:')){
          pdfUrl = pdfRawPath;
        } else {
          // resolve relative to this HTML file's URL
          pdfUrl = new URL(pdfRawPath, location.href).href;
        }
        console.info('Loading PDF from', pdfUrl);
        // Render PDF using PDF.js so we can control scrolling and sync with the explanation pane.
        async function renderPdf(url){
          pdfContainer.innerHTML = '<div style="padding:12px;color:#64748b">PDF 렌더링 중...</div>';
          try{
            const loadingTask = pdfjsLib.getDocument(url);
            const pdf = await loadingTask.promise;
            pdfContainer.innerHTML = '';
            for(let p=1;p<=pdf.numPages;p++){
              const page = await pdf.getPage(p);
              const baseViewport = page.getViewport({scale:1});
              const containerW = Math.max(320, pdfContainer.clientWidth || 800);
              const scale = (containerW - 24) / baseViewport.width;
              const viewport = page.getViewport({scale: Math.max(0.6, scale)});
              const canvas = document.createElement('canvas');
              canvas.width = Math.floor(viewport.width);
              canvas.height = Math.floor(viewport.height);
              canvas.style.display = 'block';
              canvas.style.margin = '12px auto';
              const ctx = canvas.getContext('2d');
              await page.render({canvasContext:ctx, viewport}).promise;
              pdfContainer.appendChild(canvas);
            }
            // attach scroll handler for syncing and quiz trigger
            pdfContainer.addEventListener('scroll', onPdfScroll, {passive:true});
          }catch(err){
            pdfContainer.innerHTML = '<p>PDF 렌더링 실패: 파일을 확인하세요.</p>';
            console.error(err);
          }
        }
        // kick off render
        renderPdf(pdfUrl);
      } catch(e){
        pdfContainer.innerHTML = '<p>PDF 로드 실패: 파일 경로를 확인하세요.</p>';
        console.error(e);
      }
      // === 쉬운 해설(iframe 로드) 및 스크롤 감지 ===
  const explainFrame = document.getElementById('explainFrame');
  const explainFallback = document.getElementById('explainFallback');
  const openQuizManual = document.getElementById('openQuizManual');
  const rightContent = document.getElementById('rightContent');
      explainFrame.src = explanationPath;

      // Try to attach a scroll listener inside the iframe (works when same-origin, e.g., served over http from same folder)
      function attachExplainScrollHandler(){
        try{
          const doc = explainFrame.contentDocument || explainFrame.contentWindow.document;
          const scEl = doc.scrollingElement || doc.documentElement || doc.body;
          // ensure links open in new tab
          doc.querySelectorAll && doc.querySelectorAll('a').forEach(a=>a.setAttribute('target','_blank'));
          scEl.addEventListener('scroll', ()=>{
            if (scEl.scrollTop + scEl.clientHeight >= scEl.scrollHeight - 10){
              if(!triggered){ triggered = true; setTimeout(()=> openModal(), 600); }
            }
          });
          // hide fallback if present
          explainFallback.style.display = 'none';
          return true;
        }catch(e){
          // cross-origin or file:// restrictions — show manual fallback
          explainFallback.style.display = 'block';
          console.warn('Could not attach scroll handler to explain iframe (cross-origin or file protocol).', e);
          return false;
        }
      }

      explainFrame.addEventListener('load', ()=>{
        attachExplainScrollHandler();
      });

      // manual open button fallback
      openQuizManual.addEventListener('click', ()=> openModal());

      // === ?곗뒿臾몄젣 紐⑤떖 以鍮?===
      const modalBackdrop = document.getElementById('modalBackdrop');
      const modalBody = document.getElementById('modalBody');
      const closeModal = document.getElementById('closeModal');
      let quizLoaded = false;

      function openModal(){
        if(!quizLoaded){
          // load quiz inside an iframe to preserve its original styles
          modalBody.innerHTML = '<iframe id="quizFrame" src="'+encodeURI(quizPath)+'" style="width:100%;height:70vh;border:0"></iframe>';
          quizLoaded = true;
          // if quiz iframe inserted, apply auto-hide behavior to its element
          const qf = document.getElementById('quizFrame');
          if(qf){ qf.classList.add('auto-hide-scroll'); setupAutoHideScroll(qf); }
        }
        modalBackdrop.style.display = 'flex';
      }
      closeModal.addEventListener('click', ()=> modalBackdrop.style.display='none');
      modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) modalBackdrop.style.display='none'; });

      // === 퀴즈 트리거 플래그 ===
      let triggered = false;

      // Auto-hide scrollbar helper: add .auto-hide-scroll to containers and
      // toggle .show-scroll while scrolling or on hover so scrollbars appear.
      function setupAutoHideScroll(el){
        if(!el) return;
        let t = null;
        el.classList.add('auto-hide-scroll');
        // show while scrolling
        el.addEventListener('scroll', ()=>{
          el.classList.add('show-scroll');
          clearTimeout(t);
          t = setTimeout(()=> el.classList.remove('show-scroll'), 700);
        }, {passive:true});
        // show while hovered
        el.addEventListener('mouseenter', ()=> el.classList.add('show-scroll'));
        el.addEventListener('mouseleave', ()=> el.classList.remove('show-scroll'));
      }

  // apply to the PDF container (we render pages into this so it will scroll)
  setupAutoHideScroll(pdfContainer);

  // apply globally: document root and body (page scrollbar), modal, and explain iframe element
  try{ setupAutoHideScroll(document.documentElement); }catch(e){}
  try{ setupAutoHideScroll(document.body); }catch(e){}
  const modalEl = document.querySelector('.modal');
  if(modalEl) setupAutoHideScroll(modalEl);
  // mark explain iframe element (note: cannot control iframe internal content scrollbars if cross-origin)
  if(explainFrame){ explainFrame.classList.add('auto-hide-scroll'); setupAutoHideScroll(explainFrame); }

      // PDF scroll -> right explanation sync handler
      function onPdfScroll(){
        try{
          const sc = pdfContainer;
          const denom = (sc.scrollHeight - sc.clientHeight) || 1;
          const ratio = Math.max(0, Math.min(1, sc.scrollTop / denom));
          // set right content scroll proportionally (allow programmatic scroll even if scrollbar hidden)
          rightContent.scrollTop = ratio * ((rightContent.scrollHeight - rightContent.clientHeight) || 0);
          // if left reached bottom, open quiz
          if(!triggered && sc.scrollTop + sc.clientHeight >= sc.scrollHeight - 10){
            triggered = true;
            setTimeout(()=> openModal(), 600);
          }
        }catch(e){ console.warn('onPdfScroll error', e); }
      }

      // 踰꾪듉: ?댁꽕濡??ъ빱??
      document.getElementById('openExplanation').addEventListener('click', ()=>{
        rightContent.scrollTop = 0;
        rightContent.focus();
      });

      // safety: 留뚯빟 fetch ?덉슜?섏? ?딅뒗 ?섍꼍?대㈃ ?ъ슜???덈궡 臾멸뎄
      window.addEventListener('error', (ev)=>{
        console.warn('Page error', ev.error);
      });
    })();
  </script>
  <!-- Coze chat: small toggle button + hidden anchor for chat UI -->
  <button id="coze-toggle-btn" aria-label="Open chat">💬</button>
  <div id="coze-chat-anchor" aria-hidden="true">
    <button class="coze-close" aria-label="Close chat">✕</button>
  </div>

  <!-- Coze WebChat SDK (lazy init) -->
  <script src="https://sf-cdn.coze.com/obj/unpkg-va/flow-platform/chat-app-sdk/1.2.0-beta.6/libs/oversea/index.js"></script>
  <script>
    (function(){
      let cozeClient = null;
      const BOT_ID = '7576395788172050485';
      const TOKEN = 'pat_ZLQnuC8djEQB4OY4dan3wJnpLt5VWFW42KIigBMw3OFvF3f7kbB9QV42UuNbA1q4'; // replace with real token or use server-side injection

      function initCozeIfNeeded(){
        if(cozeClient) return;
        try{
          cozeClient = new CozeWebSDK.WebChatClient({
            config:{ bot_id: BOT_ID },
            componentProps:{ title:'Coze', mountElement: document.getElementById('coze-chat-anchor') },
            auth:{ type:'token', token: TOKEN, onRefreshToken: function(){ return TOKEN } }
          });
        }catch(e){ console.warn('Coze init failed', e); }
      }

      const toggleBtn = document.getElementById('coze-toggle-btn');
      const anchor = document.getElementById('coze-chat-anchor');
      const closeBtn = anchor.querySelector('.coze-close');

      toggleBtn.addEventListener('click', ()=>{
        // initialize on first open
        initCozeIfNeeded();
        anchor.classList.add('coze-open');
        anchor.setAttribute('aria-hidden','false');
        toggleBtn.style.display = 'none';
      });
      closeBtn.addEventListener('click', ()=>{
        anchor.classList.remove('coze-open');
        anchor.setAttribute('aria-hidden','true');
        toggleBtn.style.display = 'flex';
      });
    })();
  </script>
</body>
</html>

