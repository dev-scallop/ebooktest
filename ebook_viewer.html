<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>전자책 뷰어 — PDF + 해설 + 연습문제</title>
  <style>
    :root{--bg:#f3f4f6;--card:#fff;--accent:#2563eb}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;background:var(--bg);color:#0f172a}
    .wrap{max-width:calc(100% - 32px);margin:8px 16px;height:calc(100vh - 32px);display:flex;gap:12px}
    .panel{background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(10,10,10,0.06);overflow:hidden;display:flex;flex-direction:column}
    .left{flex:0 0 60%;min-width:360px}
    .right{flex:0 0 40%;min-width:280px}
    .toolbar{padding:12px 16px;border-bottom:1px solid #e6eef7;background:linear-gradient(90deg,#fff,rgba(37,99,235,0.02));display:flex;align-items:center;gap:10px}
    .title{font-weight:700}
    .pdf-frame{flex:1;border:0;width:100%;height:100%;overflow:auto}
    .right-content{padding:14px;overflow:auto;height:100%}
    .hint{font-size:0.9rem;color:#475569}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600;border:0;cursor:pointer}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal{background:#fff;max-width:980px;width:100%;max-height:90vh;border-radius:12px;overflow:auto;box-shadow:0 20px 50px rgba(2,6,23,0.35)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid #eef2ff}
    .modal-body{padding:16px}
    .close-btn{background:#ef4444;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}

    /* Auto-hide scrollbars applied to main containers */
    html.auto-hide-scroll, body.auto-hide-scroll,
    .wrap.auto-hide-scroll, .panel.auto-hide-scroll,
    .right-content.auto-hide-scroll, #pdfContainer.auto-hide-scroll,
    .modal.auto-hide-scroll, iframe.auto-hide-scroll{scrollbar-width:none; -ms-overflow-style:none}
    html.auto-hide-scroll::-webkit-scrollbar, body.auto-hide-scroll::-webkit-scrollbar,
    .wrap.auto-hide-scroll::-webkit-scrollbar, .panel.auto-hide-scroll::-webkit-scrollbar,
    .right-content.auto-hide-scroll::-webkit-scrollbar, #pdfContainer.auto-hide-scroll::-webkit-scrollbar,
    .modal.auto-hide-scroll::-webkit-scrollbar, iframe.auto-hide-scroll::-webkit-scrollbar{width:8px;background:transparent}
    html.auto-hide-scroll::-webkit-scrollbar-thumb, body.auto-hide-scroll::-webkit-scrollbar-thumb,
    .wrap.auto-hide-scroll::-webkit-scrollbar-thumb, .panel.auto-hide-scroll::-webkit-scrollbar-thumb,
    .right-content.auto-hide-scroll::-webkit-scrollbar-thumb, #pdfContainer.auto-hide-scroll::-webkit-scrollbar-thumb,
    .modal.auto-hide-scroll::-webkit-scrollbar-thumb, iframe.auto-hide-scroll::-webkit-scrollbar-thumb{background:rgba(99,102,241,0);border-radius:8px;transition:background .18s}
    html.auto-hide-scroll:hover::-webkit-scrollbar-thumb, body.auto-hide-scroll:hover::-webkit-scrollbar-thumb,
    .wrap.auto-hide-scroll:hover::-webkit-scrollbar-thumb, .panel.auto-hide-scroll:hover::-webkit-scrollbar-thumb,
    .right-content.auto-hide-scroll:hover::-webkit-scrollbar-thumb, #pdfContainer.auto-hide-scroll:hover::-webkit-scrollbar-thumb,
    .modal.auto-hide-scroll:hover::-webkit-scrollbar-thumb, iframe.auto-hide-scroll:hover::-webkit-scrollbar-thumb,
    html.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb, body.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb,
    .wrap.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb, .panel.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb,
    .right-content.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb, #pdfContainer.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb,
    .modal.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb, iframe.auto-hide-scroll.show-scroll::-webkit-scrollbar-thumb{background:rgba(99,102,241,0.45)}
    @media (max-width:900px){.wrap{flex-direction:column;height:auto}.left,.right{flex:unset;width:100%}.right{order:2}.left{order:1}.pdf-frame{height:60vh}.right-content{height:40vh}}

    /* Coze chat: floating toggle and hidden anchor */
    #coze-toggle-btn{position:fixed;right:20px;bottom:20px;z-index:1201;width:56px;height:56px;border-radius:50%;background:#5b21b6;color:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(2,6,23,0.18);cursor:pointer;font-size:24px;border:0}
    #coze-toggle-btn:hover{transform:translateY(-2px)}
    #coze-chat-anchor{display:none}
    #coze-chat-anchor.coze-open{position:fixed;right:20px;bottom:20px;z-index:1200;width:360px;height:560px;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,23,0.18);display:block;background:#fff}
    #coze-chat-anchor.coze-open .coze-close{position:absolute;right:8px;top:8px;z-index:1210;background:transparent;border:0;color:#374151;font-size:20px;cursor:pointer}
    @media (max-width:700px){#coze-toggle-btn{right:12px;bottom:12px}#coze-chat-anchor.coze-open{right:12px;bottom:12px;width:300px;height:480px}}
    /* Reserve space so floating chat button doesn't cover right-hand content */
    .right{padding-bottom:96px}
    @media (max-width:900px){ .right{padding-bottom:76px} }
  </style>
  <script>
    // helper to encode local pdf path safely
    function fileUrlFromPath(p){
      if(p.startsWith('file:')) return p;
      let path = p.replace(/\\/g, '/');
      if(!path.startsWith('/')) path = '/' + path;
      return 'file://' + encodeURI(path);
    }
  </script>
</head>
<body>
  <div class="wrap">
    <section class="panel left">
      <div class="toolbar">
        <div style="flex:1">
          <div class="title">PDF 본문</div>
          <div class="hint">왼쪽에서 PDF 본문을 확인하세요.</div>
        </div>
        <div>
          <button id="openExplanation" class="btn">해설로 포커스</button>
        </div>
      </div>
  <!-- PDF 영역: JS에서 동적으로 iframe + object(fallback)를 넣습니다 -->
  <div id="pdfContainer" class="pdf-frame">Loading PDF...</div>
    </section>

    <aside class="panel right">
      <div class="toolbar">
        <div style="flex:1">
          <div class="title">쉬운 해설</div>
          <div class="hint">오른쪽 영역을 끝까지 스크롤하면 연습문제가 팝업으로 열립니다.</div>
        </div>
      </div>
      <div id="rightContent" class="right-content">
        <!-- 설명 페이지를 원형 그대로 보존하려면 iframe으로 불러옵니다. -->
        <iframe id="explainFrame" src="" title="쉬운 해설" style="width:100%;height:100%;border:0"></iframe>
        <!-- fallback manual open button (보안정책으로 스크립트 접근이 불가능한 경우 표시) -->
        <div id="explainFallback" style="display:none;padding:12px;text-align:center;">
          <p style="color:#64748b">해설 자동 감지가 불가능합니다. 아래 버튼을 눌러 연습문제를 직접 열어보세요.</p>
          <button id="openQuizManual" class="btn">연습문제 열기</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- modal for practice quiz -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modal-header">
        <strong>연습문제</strong>
        <div>
          <button id="closeModal" class="close-btn">닫기</button>
        </div>
      </div>
      <div id="modalBody" class="modal-body">로딩 중...</div>
    </div>
  </div>

  <script>
    (function(){
      // === ?ㅼ젙 ?뱀뀡 ===
      // 1) PDF ?뚯씪 寃쎈줈 (濡쒖뺄 ?덈? 寃쎈줈 沅뚯옣). ?꾩슂?섎㈃ 寃쎈줈瑜??섏젙?섏꽭??
      const pdfRawPath = '(10가지 핵심이론으로 만나는) 지속가능경영과 ESG-part-2.pdf';
      // 2) ?댁꽕 諛??곗뒿臾몄젣 ?뚯씪? ?꾩옱 ?대뜑(chapter_01)???덈떎怨?媛??
      const explanationPath = 'easy_explanation.html';
      const quizPath = 'practice_quiz.html';

  // === PDF 로드 ===
  const pdfContainer = document.getElementById('pdfContainer');
      try{
        // Resolve PDF path relative to the current document so filenames with spaces/한글/괄호도 work.
        // new URL(..., location.href) will create an absolute URL correctly.
        let pdfUrl;
        if (pdfRawPath.startsWith('http:') || pdfRawPath.startsWith('https:') || pdfRawPath.startsWith('file:')){
          pdfUrl = pdfRawPath;
        } else {
          // resolve relative to this HTML file's URL
          pdfUrl = new URL(pdfRawPath, location.href).href;
        }
        console.info('Loading PDF from', pdfUrl);
        // Insert iframe + object fallback so browser's PDF viewer is used (no PDF.js rendering)
        const esc = (s)=> s.replace(/"/g,'\"');
        pdfContainer.innerHTML = '' +
          '<iframe src="'+esc(pdfUrl)+'" style="width:100%;height:100%;border:0"></iframe>' +
          '<object data="'+esc(pdfUrl)+'" type="application/pdf" style="width:100%;height:100%;border:0">' +
            '<p>PDF를 보려면 <a href="'+esc(pdfUrl)+'" target="_blank">여기를 클릭하여 새 탭에서 열기</a> 하십시오.</p>' +
          '</object>';
      } catch(e){
        pdfContainer.innerHTML = '<p>PDF 로드 실패: 파일 경로를 확인하세요.</p>';
        console.error(e);
      }
      // === 쉬운 해설(iframe 로드) 및 스크롤 감지 ===
  const explainFrame = document.getElementById('explainFrame');
  const explainFallback = document.getElementById('explainFallback');
  const openQuizManual = document.getElementById('openQuizManual');
  const rightContent = document.getElementById('rightContent');
      explainFrame.src = explanationPath;

      // Try to attach a scroll listener inside the iframe (works when same-origin, e.g., served over http from same folder)
      function attachExplainScrollHandler(){
        try{
          const doc = explainFrame.contentDocument || explainFrame.contentWindow.document;
          const scEl = doc.scrollingElement || doc.documentElement || doc.body;
          // ensure links open in new tab
          doc.querySelectorAll && doc.querySelectorAll('a').forEach(a=>a.setAttribute('target','_blank'));
          scEl.addEventListener('scroll', ()=>{
            if (scEl.scrollTop + scEl.clientHeight >= scEl.scrollHeight - 10){
              if(!triggered){ triggered = true; setTimeout(()=> openModal(), 600); }
            }
          });
          // hide fallback if present
          explainFallback.style.display = 'none';
          return true;
        }catch(e){
          // cross-origin or file:// restrictions — show manual fallback
          explainFallback.style.display = 'block';
          console.warn('Could not attach scroll handler to explain iframe (cross-origin or file protocol).', e);
          return false;
        }
      }

      explainFrame.addEventListener('load', ()=>{
        attachExplainScrollHandler();
      });

      // manual open button fallback
      openQuizManual.addEventListener('click', ()=> openModal());

      // === ?곗뒿臾몄젣 紐⑤떖 以鍮?===
      const modalBackdrop = document.getElementById('modalBackdrop');
      const modalBody = document.getElementById('modalBody');
      const closeModal = document.getElementById('closeModal');
      let quizLoaded = false;

      function openModal(){
        if(!quizLoaded){
          // load quiz inside an iframe to preserve its original styles
          modalBody.innerHTML = '<iframe id="quizFrame" src="'+encodeURI(quizPath)+'" style="width:100%;height:70vh;border:0"></iframe>';
          quizLoaded = true;
          // if quiz iframe inserted, apply auto-hide behavior to its element
          const qf = document.getElementById('quizFrame');
          if(qf){ qf.classList.add('auto-hide-scroll'); setupAutoHideScroll(qf); }
        }
        modalBackdrop.style.display = 'flex';
      }
      closeModal.addEventListener('click', ()=> modalBackdrop.style.display='none');
      modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) modalBackdrop.style.display='none'; });

      // === 퀴즈 트리거 플래그 ===
      let triggered = false;

      // Auto-hide scrollbar helper: add .auto-hide-scroll to containers and
      // toggle .show-scroll while scrolling or on hover so scrollbars appear.
      function setupAutoHideScroll(el){
        if(!el) return;
        let t = null;
        el.classList.add('auto-hide-scroll');
        // show while scrolling
        el.addEventListener('scroll', ()=>{
          el.classList.add('show-scroll');
          clearTimeout(t);
          t = setTimeout(()=> el.classList.remove('show-scroll'), 700);
        }, {passive:true});
        // show while hovered
        el.addEventListener('mouseenter', ()=> el.classList.add('show-scroll'));
        el.addEventListener('mouseleave', ()=> el.classList.remove('show-scroll'));
      }

  // apply to the PDF container (we render pages into this so it will scroll)
  setupAutoHideScroll(pdfContainer);

  // apply globally: document root and body (page scrollbar), modal, and explain iframe element
  try{ setupAutoHideScroll(document.documentElement); }catch(e){}
  try{ setupAutoHideScroll(document.body); }catch(e){}
  const modalEl = document.querySelector('.modal');
  if(modalEl) setupAutoHideScroll(modalEl);
  // mark explain iframe element (note: cannot control iframe internal content scrollbars if cross-origin)
  if(explainFrame){ explainFrame.classList.add('auto-hide-scroll'); setupAutoHideScroll(explainFrame); }

      // Note: using browser PDF viewer (iframe/object) — scroll sync with iframe content is not reliable across browsers.

      // 踰꾪듉: ?댁꽕濡??ъ빱??
      document.getElementById('openExplanation').addEventListener('click', ()=>{
        rightContent.scrollTop = 0;
        rightContent.focus();
      });

      // safety: 留뚯빟 fetch ?덉슜?섏? ?딅뒗 ?섍꼍?대㈃ ?ъ슜???덈궡 臾멸뎄
      window.addEventListener('error', (ev)=>{
        console.warn('Page error', ev.error);
      });
    })();
  </script>
  <!-- Coze chat: small toggle button + hidden anchor for chat UI -->
  <button id="coze-toggle-btn" aria-label="Open chat">💬</button>
  <div id="coze-chat-anchor" aria-hidden="true">
    <button class="coze-close" aria-label="Close chat">✕</button>
  </div>

  <!-- Coze WebChat SDK (lazy init) -->
  <script src="https://sf-cdn.coze.com/obj/unpkg-va/flow-platform/chat-app-sdk/1.2.0-beta.6/libs/oversea/index.js"></script>
  <script>
    (function(){
      let cozeClient = null;
      const BOT_ID = '7576395788172050485';

      async function fetchToken(){
        try{
          console.debug('[Coze] fetching token from /api/coze-token');
          const r = await fetch('/api/coze-token', { cache: 'no-store' });
          console.debug('[Coze] token response status=', r.status);
          if(!r.ok){
            const body = await r.text().catch(()=>'<no-body>');
            console.warn('[Coze] token fetch failed, body=', body);
            throw new Error('Token fetch failed: ' + r.status);
          }
          const token = await r.text();
          console.debug('[Coze] received token length=', token ? token.length : 0);
          return token;
        }catch(e){
          console.warn('[Coze] Failed to fetch Coze token from server', e);
          throw e;
        }
      }

      async function initCozeIfNeeded(){
        if(cozeClient){ console.debug('[Coze] client already initialized'); return; }
        try{
          console.debug('[Coze] initCozeIfNeeded starting');
          const initialToken = await fetchToken();
          if(!window.CozeWebSDK){
            console.error('[Coze] SDK not loaded (window.CozeWebSDK is undefined)');
            return;
          }
          console.debug('[Coze] initializing WebChatClient with BOT_ID=', BOT_ID);
          try{
            cozeClient = new CozeWebSDK.WebChatClient({
              config:{ bot_id: BOT_ID },
              componentProps:{ title:'Coze', mountElement: document.getElementById('coze-chat-anchor') },
              auth:{ type:'token', token: initialToken, onRefreshToken: async function(){
                console.debug('[Coze] onRefreshToken called');
                return await fetchToken();
              } }
            });
            console.info('[Coze] init success', !!cozeClient);
          }catch(innerErr){
            console.error('[Coze] error constructing WebChatClient', innerErr);
          }
        }catch(e){
          console.error('[Coze] Coze init failed', e);
        }
      }

      const toggleBtn = document.getElementById('coze-toggle-btn');
      const anchor = document.getElementById('coze-chat-anchor');
      const closeBtn = anchor.querySelector('.coze-close');

      toggleBtn.addEventListener('click', async ()=>{
        console.debug('[Coze] toggle clicked');
        try{
          await initCozeIfNeeded();
          anchor.classList.add('coze-open');
          anchor.setAttribute('aria-hidden','false');
          toggleBtn.style.display = 'none';
          console.debug('[Coze] anchor opened');
        }catch(e){
          console.error('[Coze] error when opening chat', e);
          // show fallback UI hint briefly
          toggleBtn.innerText = '💬';
        }
      });
      closeBtn.addEventListener('click', ()=>{
        console.debug('[Coze] close clicked');
        anchor.classList.remove('coze-open');
        anchor.setAttribute('aria-hidden','true');
        toggleBtn.style.display = 'flex';
      });
    })();
  </script>
</body>
</html>

